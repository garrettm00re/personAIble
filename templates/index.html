<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Q&A Interface</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="top-bar">
        <span id="back-arrow" class="hidden">&#8592;</span>
        <div class="links">
            <a href="#root" onclick="navigate('root')">Home</a>
            <a href="#who" onclick="navigate('who')">Who?</a>
            <a href="#whereTo" onclick="navigate('whereTo')">Where To?</a>
            <a href="#how" onclick="navigate('how')">How?</a>
            <a href="#settings" onclick="navigate('settings')">&#128295;</a>
        </div>
    </div>
    <div id="root" class="content">
        <div class="qa-container" id="qa-container"></div>
        <div class="input-bar">
            <input type="text" id="user-input" placeholder="Type your question here...">
            <button onclick="submitQuestion()">Submit</button>
        </div>
    </div>
    <div id="who" class="content hidden">Who? Page Content</div>
    <div id="whereTo" class="content hidden">Where To? Page Content</div>
    <div id="how" class="content hidden">How? Page Content</div>
    <div id="settings" class="content hidden">Settings Page Content</div>

    <script>
        const backArrow = document.getElementById('back-arrow');
        const pages = document.querySelectorAll('.content');

        async function submitQuestion() {
            const input = document.getElementById('user-input');
            const question = input.value.trim();

            if (question) {
                addMessage(question, 'user');
                input.value = '';
                
                try {
                    const response = await fetch('/api/ask', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ question: question })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        addMessage(data.answer, 'system');
                    } else {
                        addMessage('Error: ' + data.error, 'system');
                    }
                } catch (error) {
                    addMessage('Error connecting to the server', 'system');
                    console.error('Error:', error);
                }
            }
        }

        function addMessage(text, type) {
            const qaContainer = document.getElementById('qa-container');
            const message = document.createElement('div');
            message.className = `message ${type}-message`;
            message.textContent = text;
            qaContainer.appendChild(message);
            qaContainer.scrollTop = qaContainer.scrollHeight;
        }

        // Initialize back button
        backArrow.addEventListener('click', () => navigate('root'));

        navigate('root'); // Default page
        
        function formatSubPlan(subPlan) {
        let html = '';
        
        subPlan.forEach(plan => {
            html += `
                <div class="plan-section">
                    <h3>${plan.goal.description}</h3>
                    <p><strong>Deadline:</strong> ${plan.goal.deadline}</p>
                    <p><strong>Justification:</strong> ${plan.justification}</p>
                    
                    <table class="action-table">
                        <thead>
                            <tr>
                                <th>Action Item</th>
                                <th>When</th>
                                <th>Duration</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${(plan.actionItems || plan.actionItem || []).map(item => `
                                <tr>
                                    <td>${item.what}</td>
                                    <td>${item.when}</td>
                                    <td>${item.duration}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>`;
        });
        
        return html;
    }

    function formatWho(data) {
        let html = '<div class="data-section">';
        for (const [key, value] of Object.entries(data)) {
            html += `
                <table class="info-table">
                    <thead>
                        <tr>
                            <th colspan="${Array.isArray(value) ? 1 : 2}">${key}</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            if (Array.isArray(value)) {
                value.forEach(item => {
                    html += `<tr><td>${item}</td></tr>`;
                });
            } else {
                html += `<tr><td>${value}</td></tr>`;
            }
            
            html += `</tbody></table>`;
        }
        return html + '</div>';
    }

    function formatWhereTo(data) {
        let html = `
            <table class="info-table">
                <thead>
                    <tr>
                        <th>Desire</th>
                        <th>Strength</th>
                        <th>Timeliness</th>
                    </tr>
                </thead>
                <tbody>`;
        
        data.desires.forEach(desire => {
            html += `
                <tr>
                    <td>${desire.description}</td>
                    <td>${desire.strength}</td>
                    <td>${desire.timeliness}</td>
                </tr>`;
        });
        
        return html + '</tbody></table>';
    }

    function formatHow(data) {
        let html = '';
        data.subPlan.forEach(plan => {
            html += `
                <div class="plan-section">
                    <table class="info-table">
                        <thead>
                            <tr>
                                <th colspan="2">Goal: ${plan.goal.description}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Deadline:</strong></td>
                                <td>${plan.goal.deadline}</td>
                            </tr>
                            <tr>
                                <td><strong>Justification:</strong></td>
                                <td>${plan.justification}</td>
                            </tr>
                        </tbody>
                    </table>

                    <table class="info-table action-table">
                        <thead>
                            <tr>
                                <th>Action Item</th>
                                <th>When</th>
                                <th>Duration</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${(plan.actionItems || plan.actionItem || []).map(item => `
                                <tr>
                                    <td>${item.what}</td>
                                    <td>${item.when}</td>
                                    <td>${item.duration}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>`;
        });
        return html;
    }

    async function navigate(targetId) {
        pages.forEach(page => page.classList.add('hidden'));
        const targetPage = document.getElementById(targetId);
        targetPage.classList.remove('hidden');
        backArrow.style.display = targetId === 'root' ? 'none' : 'inline';
        
        if (targetId !== 'root' && targetId !== 'settings') {
            try {
                const response = await fetch(`/api/${targetId}`);
                const data = await response.json();
                
                switch(targetId) {
                    case 'who':
                        targetPage.innerHTML = formatWho(data);
                        break;
                    case 'whereTo':
                        targetPage.innerHTML = formatWhereTo(data);
                        break;
                    case 'how':
                        targetPage.innerHTML = formatHow(data);
                        break;
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                targetPage.innerHTML = '<p>Error loading content</p>';
            }
        }
    }
    </script>
</body>
</html>
